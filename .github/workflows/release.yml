# Release workflow for Remote Compilation Helper
#
# Triggers on version tags (v*) and creates GitHub releases with:
# - Cross-platform binaries (Linux GNU/musl, macOS x86_64/ARM64, Windows)
# - SHA256 checksums for verification
# - Shell/PowerShell installers
# - Automatic release notes from commits

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: true
        type: string

# Only allow one release at a time to prevent conflicts
concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  # Reduce network retries for faster failure
  CARGO_NET_RETRY: 2

jobs:
  # Validate tag and plan the release
  plan:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      version: ${{ steps.tag.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Determine and validate tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${TAG#v}"

          # Validate semver format
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "Error: Version '$VERSION' does not match semver format"
            exit 1
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building release for tag: $TAG (version: $VERSION)"

  # Build for Linux x86_64 (GNU libc)
  build-linux-x86_64:
    needs: plan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: x86_64-unknown-linux-gnu
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-linux-x86_64
      - name: Build
        run: cargo build --release --target x86_64-unknown-linux-gnu
      - name: Package
        run: |
          mkdir -p dist
          cd target/x86_64-unknown-linux-gnu/release
          # Strip binaries for smaller size (symbols already stripped via profile.release)
          tar -czf ../../../dist/rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-gnu.tar.gz rch rchd rch-wkr
          cd ../../../dist
          sha256sum rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-gnu.tar.gz > rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-gnu.tar.gz.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: dist-linux-x86_64
          path: dist/*
          retention-days: 5

  # Build for Linux x86_64 (musl - fully static binary)
  build-linux-x86_64-musl:
    needs: plan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: x86_64-unknown-linux-musl
      - name: Install musl-tools
        run: sudo apt-get update && sudo apt-get install -y musl-tools
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-linux-musl
      - name: Build
        run: cargo build --release --target x86_64-unknown-linux-musl
      - name: Package
        run: |
          mkdir -p dist
          cd target/x86_64-unknown-linux-musl/release
          tar -czf ../../../dist/rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-musl.tar.gz rch rchd rch-wkr
          cd ../../../dist
          sha256sum rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-musl.tar.gz > rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-musl.tar.gz.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: dist-linux-x86_64-musl
          path: dist/*
          retention-days: 5

  # Build for Linux ARM64 (for AWS Graviton, Raspberry Pi, etc.)
  build-linux-aarch64:
    needs: plan
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: aarch64-unknown-linux-gnu
      - name: Install cross-compilation tools
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-linux-aarch64
      - name: Build
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: cargo build --release --target aarch64-unknown-linux-gnu
      - name: Package
        run: |
          mkdir -p dist
          cd target/aarch64-unknown-linux-gnu/release
          tar -czf ../../../dist/rch-${{ needs.plan.outputs.tag }}-aarch64-unknown-linux-gnu.tar.gz rch rchd rch-wkr
          cd ../../../dist
          sha256sum rch-${{ needs.plan.outputs.tag }}-aarch64-unknown-linux-gnu.tar.gz > rch-${{ needs.plan.outputs.tag }}-aarch64-unknown-linux-gnu.tar.gz.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: dist-linux-aarch64
          path: dist/*
          retention-days: 5

  # Build for macOS x86_64 (Intel Macs)
  build-macos-x86_64:
    needs: plan
    runs-on: macos-13  # Use macos-13 for x86_64 native build
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-macos-x86_64
      - name: Build
        run: cargo build --release --target x86_64-apple-darwin
      - name: Package
        run: |
          mkdir -p dist
          cd target/x86_64-apple-darwin/release
          tar -czf ../../../dist/rch-${{ needs.plan.outputs.tag }}-x86_64-apple-darwin.tar.gz rch rchd rch-wkr
          cd ../../../dist
          shasum -a 256 rch-${{ needs.plan.outputs.tag }}-x86_64-apple-darwin.tar.gz > rch-${{ needs.plan.outputs.tag }}-x86_64-apple-darwin.tar.gz.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: dist-macos-x86_64
          path: dist/*
          retention-days: 5

  # Build for macOS ARM64 (Apple Silicon - M1/M2/M3)
  build-macos-aarch64:
    needs: plan
    runs-on: macos-latest  # macos-latest is ARM64
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: aarch64-apple-darwin
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-macos-aarch64
      - name: Build
        run: cargo build --release --target aarch64-apple-darwin
      - name: Package
        run: |
          mkdir -p dist
          cd target/aarch64-apple-darwin/release
          tar -czf ../../../dist/rch-${{ needs.plan.outputs.tag }}-aarch64-apple-darwin.tar.gz rch rchd rch-wkr
          cd ../../../dist
          shasum -a 256 rch-${{ needs.plan.outputs.tag }}-aarch64-apple-darwin.tar.gz > rch-${{ needs.plan.outputs.tag }}-aarch64-apple-darwin.tar.gz.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: dist-macos-aarch64
          path: dist/*
          retention-days: 5

  # Build for Windows x86_64
  build-windows-x86_64:
    needs: plan
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-01-01
          targets: x86_64-pc-windows-msvc
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-windows-x86_64
      - name: Build
        run: cargo build --release --target x86_64-pc-windows-msvc
      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Compress-Archive -Path target/x86_64-pc-windows-msvc/release/rch.exe,target/x86_64-pc-windows-msvc/release/rchd.exe,target/x86_64-pc-windows-msvc/release/rch-wkr.exe -DestinationPath dist/rch-${{ needs.plan.outputs.tag }}-x86_64-pc-windows-msvc.zip
          $hash = (Get-FileHash dist/rch-${{ needs.plan.outputs.tag }}-x86_64-pc-windows-msvc.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  rch-${{ needs.plan.outputs.tag }}-x86_64-pc-windows-msvc.zip" | Out-File -FilePath dist/rch-${{ needs.plan.outputs.tag }}-x86_64-pc-windows-msvc.zip.sha256 -Encoding ascii -NoNewline
      - uses: actions/upload-artifact@v4
        with:
          name: dist-windows-x86_64
          path: dist/*
          retention-days: 5

  # Assemble all artifacts and create GitHub Release
  publish:
    needs:
      - plan
      - build-linux-x86_64
      - build-linux-x86_64-musl
      - build-linux-aarch64
      - build-macos-x86_64
      - build-macos-aarch64
      - build-windows-x86_64
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: dist-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create consolidated checksums file
        run: |
          cd artifacts
          # Combine all individual checksum files
          cat *.sha256 | sort > checksums.txt
          echo "=== checksums.txt ==="
          cat checksums.txt

      - name: Create shell installer (Unix)
        run: |
          cat > artifacts/install.sh << 'INSTALLER_EOF'
          #!/bin/sh
          # RCH Installer - Remote Compilation Helper
          # Usage: curl -fsSL https://github.com/Dicklesworthstone/remote_compilation_helper/releases/latest/download/install.sh | sh
          set -e

          REPO="Dicklesworthstone/remote_compilation_helper"
          INSTALL_DIR="${INSTALL_DIR:-$HOME/.local/bin}"

          # Color output helpers
          red() { printf '\033[31m%s\033[0m\n' "$*"; }
          green() { printf '\033[32m%s\033[0m\n' "$*"; }
          yellow() { printf '\033[33m%s\033[0m\n' "$*"; }

          # Detect platform
          OS="$(uname -s)"
          ARCH="$(uname -m)"

          case "$OS" in
              Linux)
                  case "$ARCH" in
                      x86_64)
                          # Prefer musl for maximum compatibility
                          TARGET="x86_64-unknown-linux-musl"
                          ;;
                      aarch64|arm64)
                          TARGET="aarch64-unknown-linux-gnu"
                          ;;
                      *)
                          red "Unsupported architecture: $ARCH"
                          exit 1
                          ;;
                  esac
                  ;;
              Darwin)
                  case "$ARCH" in
                      x86_64)
                          TARGET="x86_64-apple-darwin"
                          ;;
                      arm64)
                          TARGET="aarch64-apple-darwin"
                          ;;
                      *)
                          red "Unsupported architecture: $ARCH"
                          exit 1
                          ;;
                  esac
                  ;;
              *)
                  red "Unsupported OS: $OS"
                  red "For Windows, use install.ps1 instead"
                  exit 1
                  ;;
          esac

          # Get version (from env or fetch latest)
          if [ -z "$VERSION" ]; then
              yellow "Fetching latest release version..."
              VERSION=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name":' | cut -d'"' -f4)
              if [ -z "$VERSION" ]; then
                  red "Failed to determine latest version"
                  exit 1
              fi
          fi

          green "Installing RCH $VERSION for $TARGET..."

          # Create install directory
          mkdir -p "$INSTALL_DIR"

          # Download and extract
          ARCHIVE="rch-${VERSION}-${TARGET}.tar.gz"
          URL="https://github.com/$REPO/releases/download/${VERSION}/${ARCHIVE}"
          CHECKSUM_URL="https://github.com/$REPO/releases/download/${VERSION}/${ARCHIVE}.sha256"

          TEMP_DIR=$(mktemp -d)
          trap 'rm -rf "$TEMP_DIR"' EXIT

          yellow "Downloading $URL..."
          curl -fsSL "$URL" -o "$TEMP_DIR/$ARCHIVE"

          # Verify checksum
          yellow "Verifying checksum..."
          EXPECTED=$(curl -fsSL "$CHECKSUM_URL" | cut -d' ' -f1)
          if command -v sha256sum >/dev/null 2>&1; then
              ACTUAL=$(sha256sum "$TEMP_DIR/$ARCHIVE" | cut -d' ' -f1)
          else
              ACTUAL=$(shasum -a 256 "$TEMP_DIR/$ARCHIVE" | cut -d' ' -f1)
          fi

          if [ "$EXPECTED" != "$ACTUAL" ]; then
              red "Checksum verification failed!"
              red "Expected: $EXPECTED"
              red "Actual:   $ACTUAL"
              exit 1
          fi
          green "Checksum verified."

          # Extract
          tar -xzf "$TEMP_DIR/$ARCHIVE" -C "$INSTALL_DIR"

          green "Successfully installed RCH $VERSION to $INSTALL_DIR"
          echo ""
          echo "Installed binaries:"
          echo "  - $INSTALL_DIR/rch     (client CLI)"
          echo "  - $INSTALL_DIR/rchd    (daemon)"
          echo "  - $INSTALL_DIR/rch-wkr (worker)"
          echo ""

          # Check if in PATH
          case ":$PATH:" in
              *":$INSTALL_DIR:"*) ;;
              *)
                  yellow "Add $INSTALL_DIR to your PATH:"
                  echo ""
                  echo "  export PATH=\"\$PATH:$INSTALL_DIR\""
                  echo ""
                  ;;
          esac
          INSTALLER_EOF
          chmod +x artifacts/install.sh

      - name: Create PowerShell installer (Windows)
        run: |
          cat > artifacts/install.ps1 << 'INSTALLER_EOF'
          # RCH Installer for Windows
          # Usage: iwr https://github.com/Dicklesworthstone/remote_compilation_helper/releases/latest/download/install.ps1 | iex
          $ErrorActionPreference = "Stop"

          $Repo = "Dicklesworthstone/remote_compilation_helper"
          $InstallDir = if ($env:INSTALL_DIR) { $env:INSTALL_DIR } else { "$env:LOCALAPPDATA\Programs\rch" }

          Write-Host "RCH Installer - Remote Compilation Helper" -ForegroundColor Cyan
          Write-Host ""

          # Get version
          if ($env:VERSION) {
              $Version = $env:VERSION
          } else {
              Write-Host "Fetching latest release..." -ForegroundColor Yellow
              $Release = Invoke-RestMethod "https://api.github.com/repos/$Repo/releases/latest"
              $Version = $Release.tag_name
          }

          Write-Host "Installing RCH $Version..." -ForegroundColor Green

          # Prepare paths
          $Archive = "rch-$Version-x86_64-pc-windows-msvc.zip"
          $Url = "https://github.com/$Repo/releases/download/$Version/$Archive"
          $ChecksumUrl = "https://github.com/$Repo/releases/download/$Version/$Archive.sha256"
          $TempFile = Join-Path $env:TEMP $Archive

          # Download
          Write-Host "Downloading $Url..." -ForegroundColor Yellow
          Invoke-WebRequest -Uri $Url -OutFile $TempFile

          # Verify checksum
          Write-Host "Verifying checksum..." -ForegroundColor Yellow
          $ExpectedHash = ((Invoke-WebRequest -Uri $ChecksumUrl).Content -split '\s+')[0].Trim()
          $ActualHash = (Get-FileHash $TempFile -Algorithm SHA256).Hash.ToLower()

          if ($ExpectedHash -ne $ActualHash) {
              Write-Host "Checksum verification failed!" -ForegroundColor Red
              Write-Host "Expected: $ExpectedHash" -ForegroundColor Red
              Write-Host "Actual:   $ActualHash" -ForegroundColor Red
              Remove-Item $TempFile -Force
              exit 1
          }
          Write-Host "Checksum verified." -ForegroundColor Green

          # Extract
          New-Item -ItemType Directory -Force -Path $InstallDir | Out-Null
          Expand-Archive -Path $TempFile -DestinationPath $InstallDir -Force
          Remove-Item $TempFile -Force

          Write-Host ""
          Write-Host "Successfully installed RCH $Version to $InstallDir" -ForegroundColor Green
          Write-Host ""
          Write-Host "Installed binaries:" -ForegroundColor Cyan
          Write-Host "  - $InstallDir\rch.exe     (client CLI)"
          Write-Host "  - $InstallDir\rchd.exe    (daemon)"
          Write-Host "  - $InstallDir\rch-wkr.exe (worker)"
          Write-Host ""

          # Check PATH
          $UserPath = [Environment]::GetEnvironmentVariable("Path", "User")
          if ($UserPath -notlike "*$InstallDir*") {
              Write-Host "Add to PATH (requires restart of terminal):" -ForegroundColor Yellow
              Write-Host ""
              Write-Host "  `$env:Path += `";$InstallDir`"" -ForegroundColor White
              Write-Host ""
              Write-Host "Or permanently:" -ForegroundColor Yellow
              Write-Host ""
              Write-Host "  [Environment]::SetEnvironmentVariable('Path', `$env:Path + ';$InstallDir', 'User')" -ForegroundColor White
              Write-Host ""
          }
          INSTALLER_EOF

      - name: Generate release notes
        id: release_notes
        run: |
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log --oneline "$PREV_TAG..HEAD" | head -20)
          else
            COMMITS=$(git log --oneline -20)
          fi

          cat > release_notes.md << EOF
          ## What's Changed

          See the full changelog in the commit history.

          ## Installation

          ### Quick Install (Unix/macOS)
          \`\`\`bash
          curl -fsSL https://github.com/Dicklesworthstone/remote_compilation_helper/releases/download/${{ needs.plan.outputs.tag }}/install.sh | sh
          \`\`\`

          ### Quick Install (Windows PowerShell)
          \`\`\`powershell
          iwr https://github.com/Dicklesworthstone/remote_compilation_helper/releases/download/${{ needs.plan.outputs.tag }}/install.ps1 | iex
          \`\`\`

          ### Manual Download

          Download the appropriate archive for your platform:

          | Platform | Architecture | Download |
          |----------|-------------|----------|
          | Linux | x86_64 (glibc) | \`rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-gnu.tar.gz\` |
          | Linux | x86_64 (musl/static) | \`rch-${{ needs.plan.outputs.tag }}-x86_64-unknown-linux-musl.tar.gz\` |
          | Linux | ARM64 | \`rch-${{ needs.plan.outputs.tag }}-aarch64-unknown-linux-gnu.tar.gz\` |
          | macOS | Intel | \`rch-${{ needs.plan.outputs.tag }}-x86_64-apple-darwin.tar.gz\` |
          | macOS | Apple Silicon | \`rch-${{ needs.plan.outputs.tag }}-aarch64-apple-darwin.tar.gz\` |
          | Windows | x86_64 | \`rch-${{ needs.plan.outputs.tag }}-x86_64-pc-windows-msvc.zip\` |

          ### Verify Downloads

          All downloads include SHA256 checksums. Verify with:
          \`\`\`bash
          sha256sum -c rch-${{ needs.plan.outputs.tag }}-<target>.tar.gz.sha256
          \`\`\`

          Or check against \`checksums.txt\` which contains all checksums.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.plan.outputs.tag }}
          name: RCH ${{ needs.plan.outputs.tag }}
          draft: false
          prerelease: ${{ contains(needs.plan.outputs.tag, '-') }}
          body_path: release_notes.md
          generate_release_notes: true
          append_body: true
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
            artifacts/*.sha256
            artifacts/checksums.txt
            artifacts/install.sh
            artifacts/install.ps1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Published Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.plan.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.plan.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -1 artifacts/ | while read f; do
            echo "- \`$f\`" >> $GITHUB_STEP_SUMMARY
          done
